/*global define*/
define(function(require) {
  'use strict';

  var JSON = require('json-ie7'),
    $ = require('jquery'),
    _ = require('underscore'),
    Handlebars = require('handlebars'),
    viewHelper = require('../hbs/view'),
    Base = require('./base'),
    fieldTemplates = {},
    View, register;

  View = Base.extend({
    events: {
      'change input': 'inputChanged',
      'blur input': 'inputChanged',
      'change select': 'inputChanged',
      'blur select': 'inputChanged',
      'change textarea': 'inputChanged',
      'blur textarea': 'inputChanged'
    },

    initialize: function(options) {
      Base.prototype.initialize.apply(this, arguments);
      this.config = options.context;
      this.field = options.field;
    },
    inputChanged: function() {
      var val = this.$('[name=' + this.field + ']').val();
      this.model.set(this.field, val, {validate: true});
            // We want to ensure that the model value is really updated even
            // if validation fails in the previous step. However, it should be
            // silent and not trigger any change events since the previous step
            // will take care of that in the case of success.
      this.model.set(this.field, val, {silent: true});
    }
  });

  View.register = register = function(type, def) {
    var SubClass = fieldTemplates[type] = this.extend(def);
    SubClass.register = register;
    return SubClass;
  };

  View.unregister = function(type) {
    if (fieldTemplates[type]) {
      delete fieldTemplates[type];
    }
  };

  View.register('text', {
    template: require('hbs!./templates/formfield/text')
  });

  View.register('textarea', {
    template: require('hbs!./templates/formfield/textarea')
  });

  View.register('select', {
    template: require('hbs!./templates/formfield/select')
  });

  View.register('checkbox', {
    template: require('hbs!./templates/formfield/checkbox')
  });

  View.register('radio', {
    template: require('hbs!./templates/formfield/radio')
  });

  Handlebars.registerHelper('formfield', function(type, model, fieldName) {
        // template helper in the form of:
        //
        //      {{ formfield 'text' model 'fieldname' [attrName="attrValue"]*}}
    var FormField = fieldTemplates[type],
      options = arguments[arguments.length - 1],
      opts = options.hash || {};

    if (!FormField) {
      throw new Error('Unregistered formfield template: ' + type);
    }

    _.defaults(opts, {
      id: model.fieldId(fieldName),
      label: fieldName,
      name: fieldName,
      options: [],
      blank: false,
      value: model.get(fieldName) || '',
      help: ''
    });
    return viewHelper.call(this, FormField, {
      field: fieldName,
      model: model,
      context: opts
    }, options);
  });

  return View;
});
